<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Math Editor</title>
    <script src="https://unpkg.com/mathlive"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤–≤–æ–¥–∞ */
        #input-mode { display: flex; flex-direction: column; gap: 15px; }
        
        textarea {
            width: 100%;
            height: 80px;
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000);
            font-family: inherit;
            resize: none;
            box-sizing: border-box;
        }
        math-field {
            width: 100%;
            font-size: 24px;
            padding: 10px;
            border-radius: 12px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-hint-color, #ccc);
        }
        button {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –æ—Ç–≤–µ—Ç–∞ */
        #answer-mode { display: none; }
        .answer-box {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 15px;
            border-radius: 12px;
            line-height: 1.6;
        }
        h3 { margin: 0 0 10px 0; opacity: 0.7; }
    </style>
</head>
<body>

    <div id="input-mode">
        <h3>–í–∞—à –∑–∞–ø—Ä–æ—Å:</h3>
        <textarea id="user-text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–µ—à–∏ —ç—Ç–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ..."></textarea>
        
        <h3>–§–æ—Ä–º—É–ª–∞:</h3>
        <math-field id="formula" virtual-keyboard-mode="onfocus"></math-field>

        <button onclick="sendData()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É</button>
    </div>

    <div id="answer-mode">
        <h3>üéì –û—Ç–≤–µ—Ç Mistral AI:</h3>
        <div id="answer-content" class="answer-box"></div>
        <button onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã–ª–∏ –ª–∏ –Ω–∞—Å —Å –æ—Ç–≤–µ—Ç–æ–º (–∏–∑ –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞)
        const urlParams = new URLSearchParams(window.location.search);
        const answerData = urlParams.get('data');

        if (answerData) {
            // --- –í–ö–õ–Æ–ß–ê–ï–ú –†–ï–ñ–ò–ú –ü–†–û–°–ú–û–¢–†–ê ---
            document.getElementById('input-mode').style.display = 'none';
            document.getElementById('answer-mode').style.display = 'block';
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –∏–∑ URL
            const decodedText = decodeURIComponent(answerData);
            const displayArea = document.getElementById('answer-content');
            
            // 1. –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º Markdown –≤ HTML
            displayArea.innerHTML = marked.parse(decodedText);
            
            // 2. –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã (LaTeX -> –ö—Ä–∞—Å–∏–≤—ã–µ —Å–∏–º–≤–æ–ª—ã)
            renderMathInElement(displayArea, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });

        } else {
            // --- –í–ö–õ–Æ–ß–ê–ï–ú –†–ï–ñ–ò–ú –í–í–û–î–ê ---
            document.getElementById('input-mode').style.display = 'flex';
        }

        function sendData() {
            const text = document.getElementById('user-text').value;
            const latex = document.getElementById('formula').value;

            if (!text && !latex) {
                tg.showPopup({title: '–û—à–∏–±–∫–∞', message: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ä–º—É–ª—É'});
                return;
            }

            // –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –≤—Å—ë –≤ JSON
            const data = JSON.stringify({
                text: text,
                formula: latex
            });
            
            tg.sendData(data);
        }
    </script>
</body>
</html>
