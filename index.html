<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Editor & Dashboard</title>
    <script src="https://unpkg.com/mathlive"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"></script>

    <style>
        /* ... (–ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è) ... */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            margin: 0; padding: 16px;
            display: flex; flex-direction: column; min-height: 100vh; box-sizing: border-box;
        }

        /* === –§–ò–ö–° –î–õ–Ø –§–û–†–ú–£–õ (–ß–¢–û–ë–´ –ù–ï –ë–´–õ–û –ß–ï–†–ù–´–ú) === */
        math-field {
            width: 100%;
            font-size: 24px;
            padding: 8px;
            /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã–π —Ñ–æ–Ω –∏ —á–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –≤–µ–∑–¥–µ */
            background-color: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 10px;
            --caret-color: #000; /* –ö—É—Ä—Å–æ—Ä —á–µ—Ä–Ω—ã–π */
        }
        /* –ö—Ä–∞—Å–∏–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ */
        math-field::part(virtual-keyboard-toggle) {
            color: #000;
        }

        /* ... (–°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ –∏ –∏–Ω–ø—É—Ç–æ–≤ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –∫–æ–¥–∞) ... */
        textarea { width: 100%; height: 100px; border-radius: 12px; padding: 12px; border: 1px solid #ccc; background: var(--tg-theme-secondary-bg-color, #f5f5f5); color: var(--tg-theme-text-color, #000); resize: none; box-sizing: border-box; outline: none; }
        button { border: none; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-insert { background: #e0e0e0; color: #333; }
        .btn-send { background: var(--tg-theme-button-color, #3390ec); color: white; }
        .answer-box { background: var(--tg-theme-section-bg-color, #fff); padding: 16px; border-radius: 12px; border: 1px solid #eee; word-wrap: break-word; }

        /* === –°–¢–ò–õ–ò –ê–î–ú–ò–ù–ö–ò === */
        #admin-mode { display: none; flex-direction: column; height: 100vh; }
        .user-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #ccc; }
        .user-card { 
            min-width: 120px; 
            background: var(--tg-theme-secondary-bg-color, #eee); 
            padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; 
            border: 2px solid transparent;
        }
        .user-card.active { border-color: var(--tg-theme-button-color, #3390ec); background: #fff; }
        .user-name { font-weight: bold; font-size: 14px; display: block; overflow: hidden; text-overflow: ellipsis; }
        .user-id { font-size: 11px; opacity: 0.6; }
        
        .chat-viewer { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: rgba(0,0,0,0.02); border-radius: 8px; }
        .msg { padding: 10px; border-radius: 8px; max-width: 85%; font-size: 14px; }
        .msg.user { align-self: flex-end; background: var(--tg-theme-button-color, #3390ec); color: white; }
        .msg.assistant { align-self: flex-start; background: var(--tg-theme-secondary-bg-color, #e0e0e0); color: var(--tg-theme-text-color, #000); }
        .msg-role { font-size: 10px; opacity: 0.7; margin-bottom: 4px; display: block; }

        /* –°–∫—Ä—ã—Ç–∏–µ –±–ª–æ–∫–æ–≤ */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="input-mode">
        <label>üìù –¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏:</label>
        <textarea id="main-text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..."></textarea>
        
        <div style="margin-top: 15px;">
            <label>üßÆ –§–æ—Ä–º—É–ª–∞ (—Ñ–æ–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω):</label>
            <math-field id="math-input" virtual-keyboard-mode="onfocus"></math-field>
            <button class="btn-insert" onclick="insertFormula()">‚¨ÜÔ∏è –í—Å—Ç–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É</button>
        </div>
        <button class="btn-send" onclick="sendData()">‚úàÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div id="answer-mode" class="hidden">
        <h3>üéì –†–µ—à–µ–Ω–∏–µ:</h3>
        <div id="answer-content" class="answer-box"></div>
        <button style="background: #ccc; color: #333;" onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="admin-mode">
        <h3>üëë –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
        <div id="loading-admin">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã...</div>
        
        <div id="users-container" class="user-list hidden"></div>
        
        <div id="chat-container" class="chat-viewer hidden">
            <div style="text-align: center; opacity: 0.5; margin-top: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        marked.use({ breaks: true, gfm: true });

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–†–µ–Ω–¥–µ—Ä —Ñ–æ—Ä–º—É–ª) ---
        function renderContent(text, elementId = 'answer-content') {
            const displayArea = document.getElementById(elementId);
            const mathBlocks = [];
            let protectedText = text.replace(/\$\$([\s\S]*?)\$\$/g, (m) => { mathBlocks.push(m); return '%%%BLK'+(mathBlocks.length-1)+'%%%'; });
            protectedText = protectedText.replace(/\$([\s\S]*?)\$/g, (m) => { mathBlocks.push(m); return '%%%INL'+(mathBlocks.length-1)+'%%%'; });
            
            let html = marked.parse(protectedText);
            html = html.replace(/%%%BLK(\d+)%%%/g, (m, id) => mathBlocks[id]).replace(/%%%INL(\d+)%%%/g, (m, id) => mathBlocks[id]);
            
            displayArea.innerHTML = html;
            renderMathInElement(displayArea, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false} ], throwOnError: false });
        }

        // --- –õ–û–ì–ò–ö–ê –í–í–û–î–ê ---
        function insertFormula() {
            const mf = document.getElementById('math-input');
            const ta = document.getElementById('main-text');
            if (!mf.value) return;
            const tag = " $" + mf.value + "$ ";
            const start = ta.selectionStart;
            ta.value = ta.value.slice(0, start) + tag + ta.value.slice(ta.selectionEnd);
            ta.focus(); ta.selectionStart = start + tag.length; mf.setValue(""); 
        }
        function sendData() {
            const text = document.getElementById('main-text').value;
            if (!text.trim()) return tg.showPopup({message: '–ü—É—Å—Ç–æ!'});
            tg.sendData(JSON.stringify({ full_text: text }));
        }

        // --- –ì–õ–ê–í–ù–´–ô –†–û–£–¢–ï–† ---
        const params = new URLSearchParams(window.location.search);
        const adminBinId = params.get('adminBinId'); // –ï—Å–ª–∏ –µ—Å—Ç—å —ç—Ç–æ - –º—ã –ê–¥–º–∏–Ω
        const dataId = params.get('binId');          // –ï—Å–ª–∏ –µ—Å—Ç—å —ç—Ç–æ - –º—ã —Å–º–æ—Ç—Ä–∏–º –æ—Ç–≤–µ—Ç
        const directData = params.get('data');

        if (adminBinId) {
            // === –†–ï–ñ–ò–ú –ê–î–ú–ò–ù–ê ===
            document.getElementById('input-mode').classList.add('hidden');
            document.getElementById('admin-mode').style.display = 'flex';
            loadAdminData(adminBinId);

        } else if (dataId || directData) {
            // === –†–ï–ñ–ò–ú –ü–†–û–°–ú–û–¢–†–ê –û–¢–í–ï–¢–ê ===
            document.getElementById('input-mode').classList.add('hidden');
            document.getElementById('answer-mode').classList.remove('hidden');
            if (directData) {
                renderContent(decodeURIComponent(directData));
            } else {
                fetch(`https://api.jsonbin.io/v3/b/${dataId}/latest`).then(r=>r.json()).then(j => {
                    renderContent(j.record.answer || j.answer);
                });
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù–ö–ò ---
        function loadAdminData(binId) {
            fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {headers: {'X-Bin-Meta': 'false'}})
            .then(r => r.json())
            .then(db => {
                document.getElementById('loading-admin').classList.add('hidden');
                document.getElementById('users-container').classList.remove('hidden');
                document.getElementById('chat-container').classList.remove('hidden');
                renderUserList(db);
            })
            .catch(e => document.getElementById('loading-admin').innerText = "–û—à–∏–±–∫–∞: " + e);
        }

        function renderUserList(db) {
            const container = document.getElementById('users-container');
            container.innerHTML = "";
            
            // db = { chat_id: { name: "...", history: [...] }, ... }
            Object.keys(db).forEach(userId => {
                const user = db[userId];
                const card = document.createElement('div');
                card.className = 'user-card';
                card.innerHTML = `<span class="user-name">${user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</span><span class="user-id">${userId}</span>`;
                
                card.onclick = () => {
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
                    document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    renderChat(user.history);
                };
                container.appendChild(card);
            });
        }

        function renderChat(history) {
            const chatDiv = document.getElementById('chat-container');
            chatDiv.innerHTML = "";
            if (!history || history.length === 0) {
                chatDiv.innerHTML = "<div style='text-align:center'>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>";
                return;
            }
            
            history.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `msg ${msg.role}`;
                // –ó–∞—â–∏—Ç–∞ –æ—Ç XSS (–≤—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç)
                const roleName = msg.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : 'AI';
                bubble.innerHTML = `<span class="msg-role">${roleName}</span><div class="content"></div>`;
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç (Markdown + Math) –≤–Ω—É—Ç—Ä–∏
                // –í–ê–ñ–ù–û: —Å–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã renderContent —Å—Ä–∞–±–æ—Ç–∞–ª
                const uniqueId = 'msg-' + Math.random().toString(36).substr(2, 9);
                bubble.querySelector('.content').id = uniqueId;
                chatDiv.appendChild(bubble);
                
                renderContent(msg.content, uniqueId);
            });
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
    </script>
</body>
</html>
