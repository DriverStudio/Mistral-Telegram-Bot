<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Math Editor</title>
    <script src="https://unpkg.com/mathlive"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤–≤–æ–¥–∞ */
        #input-mode { display: flex; flex-direction: column; gap: 15px; }
        
        textarea {
            width: 100%;
            height: 80px;
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000);
            font-family: inherit;
            resize: none;
            box-sizing: border-box;
        }
        math-field {
            width: 100%;
            font-size: 24px;
            padding: 10px;
            border-radius: 12px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-hint-color, #ccc);
        }
        button {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –æ—Ç–≤–µ—Ç–∞ */
        #answer-mode { display: none; }
        .answer-box {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 15px;
            border-radius: 12px;
            line-height: 1.6;
        }
        h3 { margin: 0 0 10px 0; opacity: 0.7; }
    </style>
</head>
<body>

    <div id="input-mode">
        <h3>–í–∞—à –∑–∞–ø—Ä–æ—Å:</h3>
        <textarea id="user-text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–µ—à–∏ —ç—Ç–æ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ..."></textarea>
        
        <h3>–§–æ—Ä–º—É–ª–∞:</h3>
        <math-field id="formula" virtual-keyboard-mode="onfocus"></math-field>

        <button onclick="sendData()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É</button>
    </div>

    <div id="answer-mode">
        <h3>üéì –û—Ç–≤–µ—Ç Mistral AI:</h3>
        <div id="answer-content" class="answer-box"></div>
        <button onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const urlParams = new URLSearchParams(window.location.search);
        const answerData = urlParams.get('data');

        if (answerData) {
            // --- –†–ï–ñ–ò–ú –ü–†–û–°–ú–û–¢–†–ê ---
            document.getElementById('input-mode').style.display = 'none';
            document.getElementById('answer-mode').style.display = 'block';
            
            const decodedText = decodeURIComponent(answerData);
            const displayArea = document.getElementById('answer-content');
            
            // 1. –°–Ω–∞—á–∞–ª–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å (Markdown –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –ø–æ–∑–∂–µ)
            // –≠—Ç–æ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã Markdown –Ω–µ —Å–ª–æ–º–∞–ª —Ñ–æ—Ä–º—É–ª—ã –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –∏—Ö –Ω–∞–π–¥–µ—Ç KaTeX
            displayArea.innerHTML = marked.parse(decodedText);
            
            // 2. –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ñ–æ—Ä–º—É–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
            renderMathInElement(displayArea, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},  // –°—Ç–∞–Ω–¥–∞—Ä—Ç $$...$$
                    {left: '$', right: '$', display: false},   // –°—Ç–∞–Ω–¥–∞—Ä—Ç $...$
                    {left: '\\[', right: '\\]', display: true}, // LaTeX \[...\]
                    {left: '\\(', right: '\\)', display: false}, // LaTeX \(...\)
                    // –ò–Ω–æ–≥–¥–∞ LLM –æ—à–∏–±–∞—é—Ç—Å—è –∏ –ø—Ä–∏—Å—ã–ª–∞—é—Ç –±–µ–∑ —Å–ª—ç—à–µ–π, –ª–æ–≤–∏–º –∏ —ç—Ç–æ:
                    {left: '[', right: ']', display: true},    
                    //{left: '(', right: ')', display: false} // –û–ø–∞—Å–Ω–æ –≤–∫–ª—é—á–∞—Ç—å, –º–æ–∂–µ—Ç –∑–∞–¥–µ—Ç—å –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
                ],
                throwOnError: false,
                errorColor: '#cc0000',
                strict: false,
                trust: true
            });

        } else {
            // --- –†–ï–ñ–ò–ú –í–í–û–î–ê ---
            document.getElementById('input-mode').style.display = 'flex';
        }

        function sendData() {
            const text = document.getElementById('user-text').value;
            const latex = document.getElementById('formula').value;

            if (!text && !latex) {
                tg.showPopup({title: '–û—à–∏–±–∫–∞', message: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ä–º—É–ª—É'});
                return;
            }

            const data = JSON.stringify({
                text: text,
                formula: latex
            });
            
            tg.sendData(data);
        }
    </script>
</body>
</html>

