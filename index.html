<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Editor & Dashboard</title>
    <script src="https://unpkg.com/mathlive"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            margin: 0; padding: 16px;
            display: flex; flex-direction: column; min-height: 100vh; box-sizing: border-box;
        }

        /* === –§–ò–ö–° –î–õ–Ø –§–û–†–ú–£–õ === */
        math-field {
            width: 100%; font-size: 24px; padding: 8px;
            background-color: #ffffff !important; color: #000000 !important;
            border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px;
        }
        textarea { width: 100%; height: 100px; border-radius: 12px; padding: 12px; border: 1px solid #ccc; background: var(--tg-theme-secondary-bg-color, #f5f5f5); color: var(--tg-theme-text-color, #000); resize: none; outline: none; box-sizing: border-box;}
        button { border: none; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-insert { background: #e0e0e0; color: #333; }
        .btn-send { background: var(--tg-theme-button-color, #3390ec); color: white; }
        .answer-box { background: var(--tg-theme-section-bg-color, #fff); padding: 16px; border-radius: 12px; border: 1px solid #eee; word-wrap: break-word; }

        /* === –°–¢–ò–õ–ò –ê–î–ú–ò–ù–ö–ò === */
        #admin-mode { display: none; flex-direction: column; height: 100vh; }
        .user-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #ccc; }
        .user-card { 
            min-width: 120px; background: var(--tg-theme-secondary-bg-color, #eee); 
            padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; border: 2px solid transparent;
        }
        .user-card.active { border-color: var(--tg-theme-button-color, #3390ec); background: #fff; }
        .user-name { font-weight: bold; font-size: 14px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 110px; }
        .user-id { font-size: 11px; opacity: 0.6; }
        
        .chat-viewer { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 8px; }
        .msg { padding: 10px; border-radius: 8px; max-width: 85%; font-size: 14px; }
        .msg.user { align-self: flex-end; background: var(--tg-theme-button-color, #3390ec); color: white; }
        .msg.assistant { align-self: flex-start; background: var(--tg-theme-secondary-bg-color, #e0e0e0); color: var(--tg-theme-text-color, #000); }
        .msg-role { font-size: 10px; opacity: 0.7; margin-bottom: 4px; display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="input-mode">
        <label>üìù –¢–µ–∫—Å—Ç:</label>
        <textarea id="main-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..."></textarea>
        <div>
            <label>üßÆ –§–æ—Ä–º—É–ª–∞:</label>
            <math-field id="math-input" virtual-keyboard-mode="onfocus"></math-field>
            <button class="btn-insert" onclick="insertFormula()">‚¨ÜÔ∏è –í—Å—Ç–∞–≤–∏—Ç—å</button>
        </div>
        <button class="btn-send" onclick="sendData()">‚úàÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div id="answer-mode" class="hidden">
        <h3>üéì –†–µ—à–µ–Ω–∏–µ:</h3>
        <div id="answer-content" class="answer-box"></div>
        <button style="background: #ccc; color: #333;" onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="admin-mode">
        <h3>üëë Dashboard</h3>
        <div id="loading-admin">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="users-container" class="user-list hidden"></div>
        <div id="chat-container" class="chat-viewer hidden">
            <div style="text-align: center; opacity: 0.5; margin-top: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        marked.use({ breaks: true, gfm: true });

        function renderContent(text, elId='answer-content') {
            const da = document.getElementById(elId);
            const mb = [];
            let pt = text.replace(/\$\$([\s\S]*?)\$\$/g, m=>{mb.push(m);return '%%%B'+(mb.length-1)+'%%%'});
            pt = pt.replace(/\$([\s\S]*?)\$/g, m=>{mb.push(m);return '%%%I'+(mb.length-1)+'%%%'});
            let html = marked.parse(pt);
            html = html.replace(/%%%B(\d+)%%%/g, (m,i)=>mb[i]).replace(/%%%I(\d+)%%%/g, (m,i)=>mb[i]);
            da.innerHTML = html;
            renderMathInElement(da, {delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}], throwOnError:false});
        }

        function insertFormula() {
            const mf = document.getElementById('math-input'), ta = document.getElementById('main-text');
            if(!mf.value) return;
            const tag=" $"+mf.value+"$ ", s=ta.selectionStart;
            ta.value=ta.value.slice(0,s)+tag+ta.value.slice(ta.selectionEnd);
            ta.focus(); ta.selectionStart=s+tag.length; mf.setValue("");
        }
        function sendData() {
            const t=document.getElementById('main-text').value;
            if(!t.trim()) return tg.showPopup({message:'–ü—É—Å—Ç–æ!'});
            tg.sendData(JSON.stringify({full_text:t}));
        }

        const params = new URLSearchParams(window.location.search);
        const adminId = params.get('adminBinId'), dataId = params.get('binId'), direct = params.get('data');

        if(adminId) {
            document.getElementById('input-mode').classList.add('hidden');
            document.getElementById('admin-mode').style.display = 'flex';
            
            // === –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ê–î–ú–ò–ù–ö–ò ===
            fetch(`https://api.jsonbin.io/v3/b/${adminId}/latest`, {headers:{'X-Bin-Meta':'false'}})
            .then(r=>r.json())
            .then(json => {
                // Jsonbin –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å { "record": { ... } } –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ { ... }
                // –ë–µ—Ä–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏
                const realDb = json.record || json;
                
                document.getElementById('loading-admin').classList.add('hidden');
                document.getElementById('users-container').classList.remove('hidden');
                document.getElementById('chat-container').classList.remove('hidden');
                renderUserList(realDb);
            })
            .catch(e => document.getElementById('loading-admin').innerHTML = "–û—à–∏–±–∫–∞: "+e);

        } else if(dataId || direct) {
            document.getElementById('input-mode').classList.add('hidden');
            document.getElementById('answer-mode').classList.remove('hidden');
            if(direct) renderContent(decodeURIComponent(direct));
            else fetch(`https://api.jsonbin.io/v3/b/${dataId}/latest`).then(r=>r.json()).then(j=>{
                renderContent(j.record?.answer || j.answer || JSON.stringify(j));
            });
        }

        function renderUserList(db) {
            const c = document.getElementById('users-container');
            c.innerHTML = "";
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–ª—é—á–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–ª—è (metadata, record –∏ —Ç.–¥.)
            const userIds = Object.keys(db).filter(k => k !== 'metadata' && k !== 'record' && typeof db[k] === 'object');
            
            if(userIds.length === 0) {
                c.innerHTML = "<div style='padding:10px'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>";
                return;
            }

            userIds.forEach(uid => {
                const u = db[uid];
                const card = document.createElement('div');
                card.className = 'user-card';
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ –∏–º–µ–Ω–∏
                const name = u.name ? u.name : '–ë–µ–∑ –∏–º–µ–Ω–∏';
                card.innerHTML = `<span class="user-name">${name}</span><span class="user-id">${uid}</span>`;
                card.onclick = () => {
                    document.querySelectorAll('.user-card').forEach(x=>x.classList.remove('active'));
                    card.classList.add('active');
                    renderChat(u.history || []);
                };
                c.appendChild(card);
            });
        }

        function renderChat(h) {
            const d = document.getElementById('chat-container');
            d.innerHTML = "";
            if(!h || h.length===0) return d.innerHTML="<div style='text-align:center;margin-top:20px'>–ü—É—Å—Ç–æ</div>";
            h.forEach(m => {
                const b = document.createElement('div');
                b.className = `msg ${m.role}`;
                const uid = 'msg-'+Math.random().toString(36).substr(2,9);
                b.innerHTML = `<span class="msg-role">${m.role==='user'?'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å':'AI'}</span><div id="${uid}"></div>`;
                d.appendChild(b);
                renderContent(m.content, uid);
            });
            d.scrollTop = d.scrollHeight;
        }
    </script>
</body>
</html>
